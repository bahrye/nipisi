function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Nipisi Digital Market')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getAppData() {
  return {
    produk: getData('Produk'),
    toko: getData('Toko'),
    pengumuman: getData('Pengumuman'),
    darurat: getData('Darurat'),
    iuran: getData('Iuran'),
    // Fitur Baru
    agenda: getData('Agenda'),
    harga: getData('Harga'),
    galeri: getData('Galeri')
  };
}

function getData(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  return data.map(row => {
    let obj = {};
    headers.forEach((header, i) => obj[header] = row[i]);
    return obj;
  });
}

// --- LOGIKA ADMIN ---
function checkAdminLogin(password) {
  return password === "nipisi123"; // Ganti Password Disini
}

function updateAnnouncement(text) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Pengumuman');
  if(sheet) {
    sheet.getRange("A2").setValue(text);
    return "Pengumuman berhasil diperbarui!";
  }
  return "Sheet Pengumuman tidak ditemukan.";
}

function addProductFromAdmin(obj) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Produk');
  if(sheet) {
    const lastId = sheet.getLastRow();
    sheet.appendRow([lastId, obj.nama, obj.kategori, obj.harga, obj.toko, obj.wa, obj.gambar]);
    return "Produk berhasil diterbitkan!";
  }
  return "Sheet Produk tidak ditemukan.";
}

// --- LOGIKA LAYANAN ---
function submitPengaduan(obj) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Pengaduan');
  if(sheet) {
    sheet.appendRow([new Date(), obj.nama, obj.judul, obj.isi, "Proses"]);
    return "Laporan diterima!";
  }
  return "Gagal (Sheet Pengaduan hilang).";
}

function submitSurat(obj) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Surat');
  if(sheet) {
    sheet.appendRow([new Date(), obj.nama, obj.nik, obj.jenis, obj.perlu, "Diajukan"]);
    return "Permohonan Surat Terkirim! Silakan hubungi Pak Lingkungan untuk konfirmasi.";
  }
  return "Gagal (Sheet Surat hilang).";
}

function cekIuranWarga(nama) {
  const data = getData('Iuran');
  if (!nama) return [];
  return data.filter(d => d['Nama Warga'] && d['Nama Warga'].toString().toLowerCase().includes(nama.toLowerCase()));
}
