function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Nipisi Digital Market')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Mengambil semua data
function getAppData() {
  return {
    produk: getData('Produk'),
    toko: getData('Toko'),
    pengumuman: getData('Pengumuman'),
    darurat: getData('Darurat'),
    iuran: getData('Iuran')
  };
}

function getData(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  const headers = data.shift(); // Ambil header
  return data.map(row => {
    let obj = {};
    headers.forEach((header, i) => obj[header] = row[i]);
    return obj;
  });
}

// Logika Admin
function checkAdminLogin(password) {
  const PASS_ADMIN = "nipisi123"; 
  return password === PASS_ADMIN;
}

function updateAnnouncement(text) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Pengumuman');
  if (sheet) {
    sheet.getRange("A2").setValue(text);
    sheet.getRange("B2").setValue("Aktif");
    return "Pengumuman berhasil diperbarui!";
  }
  return "Error: Sheet Pengumuman tidak ditemukan.";
}

function addProductFromAdmin(obj) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Produk');
  if (!sheet) return "Error: Sheet Produk tidak ditemukan.";
  const lastId = sheet.getLastRow();
  sheet.appendRow([lastId, obj.nama, obj.kategori, obj.harga, obj.toko, obj.wa, obj.gambar]);
  return "Produk " + obj.nama + " berhasil diterbitkan!";
}

function submitPengaduan(obj) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Pengaduan');
  if (sheet) {
    sheet.appendRow([new Date(), obj.nama, obj.judul, obj.isi, "Proses"]);
    return "Laporan diterima!";
  }
  return "Gagal mengirim laporan.";
}

function cekIuranWarga(nama) {
  const data = getData('Iuran');
  if (!nama) return [];
  return data.filter(d => d['Nama Warga'] && d['Nama Warga'].toString().toLowerCase().includes(nama.toLowerCase()));
}
