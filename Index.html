<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
    .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
    .nav-active { color: #2563eb !important; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .main-footer { text-align: center; padding: 20px 0; font-size: 11px; color: #94a3b8; margin-top: 20px; }
    
    /* Animasi Loading */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #3498db;
      width: 20px;
      height: 20px;
      -webkit-animation: spin 1s linear infinite; /* Safari */
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="pb-28">

  <header class="bg-blue-600 text-white p-6 rounded-b-[40px] shadow-lg sticky top-0 z-50">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Nipisi Digital</h1>
        <p class="text-[10px] opacity-80 uppercase tracking-widest font-semibold">Lingkungan Nipisi Berdaya</p>
      </div>
      <button onclick="showAdminLogin()" class="bg-white/20 p-2 rounded-full hover:bg-white/30 transition">
        <i class="fa fa-lock-open text-sm"></i>
      </button>
    </div>
    
    <div class="bg-black/10 p-2 rounded-2xl text-[11px] flex items-center">
      <span class="bg-yellow-400 text-blue-900 px-2 py-0.5 rounded-lg font-bold mr-2 uppercase">Info</span>
      <marquee id="marquee-text" class="font-medium text-white">Memuat data lingkungan...</marquee>
    </div>
  </header>

  <main class="px-5 mt-6">
    
    <div id="menu-grid" class="grid grid-cols-4 gap-4 mb-8">
      <div onclick="showLapor()" class="flex flex-col items-center active:scale-95 transition cursor-pointer">
        <div class="bg-orange-100 text-orange-600 w-14 h-14 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fa fa-bullhorn text-xl"></i></div>
        <span class="text-[10px] font-bold opacity-70">LAPOR</span>
      </div>
      <div onclick="showIuran()" class="flex flex-col items-center active:scale-95 transition cursor-pointer">
        <div class="bg-indigo-100 text-indigo-600 w-14 h-14 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fa fa-wallet text-xl"></i></div>
        <span class="text-[10px] font-bold opacity-70">IURAN</span>
      </div>
      <div onclick="showEmergency()" class="flex flex-col items-center active:scale-95 transition cursor-pointer">
        <div class="bg-red-100 text-red-600 w-14 h-14 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fa fa-phone-alt text-xl"></i></div>
        <span class="text-[10px] font-bold opacity-70">DARURAT</span>
      </div>
      <div onclick="loadSection('map')" class="flex flex-col items-center active:scale-95 transition cursor-pointer">
        <div class="bg-green-100 text-green-600 w-14 h-14 rounded-2xl flex items-center justify-center mb-2 shadow-sm"><i class="fa fa-map-marked-alt text-xl"></i></div>
        <span class="text-[10px] font-bold opacity-70">PETA</span>
      </div>
    </div>

    <div id="dynamic-content" class="space-y-6 min-h-[300px]">
      <div class="py-20 text-center text-gray-400">
        <div class="loader mb-2"></div>
        <p class="text-sm">Sinkronisasi Data...</p>
      </div>
    </div>
  </main>

  <footer class="main-footer">
    <p>&copy; <span id="currentYear"></span> Created by Syamsul Bahri</p>
  </footer>

  <nav class="fixed bottom-0 w-full glass border-t border-gray-100 px-8 py-4 flex justify-between items-center z-50">
    <button id="nav-home" onclick="loadSection('home')" class="flex flex-col items-center gap-1 text-blue-600 transition-colors duration-300">
      <i class="fa fa-home text-xl"></i><span class="text-[9px] font-bold uppercase">Beranda</span>
    </button>
    <button id="nav-market" onclick="loadSection('market')" class="flex flex-col items-center gap-1 text-gray-400 transition-colors duration-300">
      <i class="fa fa-store text-xl"></i><span class="text-[9px] font-bold uppercase">Toko</span>
    </button>
    <button id="nav-profile" onclick="loadSection('profile')" class="flex flex-col items-center gap-1 text-gray-400 transition-colors duration-300">
      <i class="fa fa-user-circle text-xl"></i><span class="text-[9px] font-bold uppercase">Profil</span>
    </button>
  </nav>

  <script>
    var masterData = {};

    // Inisialisasi Saat Halaman Dimuat
    window.onload = function() {
      document.getElementById('currentYear').innerText = new Date().getFullYear();
      
      google.script.run.withSuccessHandler(function(data) {
        masterData = data;
        
        // Update Pengumuman dengan Pengecekan Aman
        var infoText = "Selamat Datang di Nipisi Digital!";
        if (masterData.pengumuman && masterData.pengumuman.length > 0) {
           var item = masterData.pengumuman[0];
           if(item && item.Isi) infoText = item.Isi;
        }
        document.getElementById('marquee-text').innerText = infoText;
        
        // Masuk ke Halaman Utama
        loadSection('home');
      }).getAppData();
    };

    // Fungsi Navigasi Utama
    function loadSection(section) {
      // Reset Warna Tombol Navigasi
      var navIds = ['nav-home', 'nav-market', 'nav-profile'];
      for (var i = 0; i < navIds.length; i++) {
        var btn = document.getElementById(navIds[i]);
        if(btn) {
            btn.classList.remove('text-blue-600');
            btn.classList.add('text-gray-400');
        }
      }
      
      var activeBtn = document.getElementById('nav-' + section);
      if(activeBtn) {
        activeBtn.classList.remove('text-gray-400');
        activeBtn.classList.add('text-blue-600');
      }

      var container = document.getElementById('dynamic-content');
      var html = "";

      // --- HALAMAN BERANDA (DAFTAR PRODUK) ---
      if(section === 'home') {
        html += '<div class="relative mb-6">';
        html += '<input type="text" onkeyup="searchProduct(this.value)" placeholder="Cari kebutuhan..." class="w-full p-4 pl-12 rounded-2xl border-none shadow-sm text-sm focus:ring-2 focus:ring-blue-400 bg-white">';
        html += '<i class="fa fa-search absolute left-4 top-4.5 text-gray-300"></i>';
        html += '</div>';
        
        html += '<h3 class="font-bold text-gray-800 text-lg flex items-center gap-2 mb-4"><i class="fa fa-shopping-bag text-blue-500"></i> Produk Terbaru</h3>';
        html += '<div id="product-list" class="grid grid-cols-2 gap-4">';
        
        if (masterData.produk && masterData.produk.length > 0) {
            for (var j = 0; j < masterData.produk.length; j++) {
                var p = masterData.produk[j];
                var imgUrl = p.GambarURL || 'https://via.placeholder.com/300?text=No+Image';
                var kat = p.Kategori || 'Umum';
                var nama = p['Nama Barang'] || 'Produk';
                var toko = p['Toko'] || 'Nipisi';
                var harga = Number(p.Harga).toLocaleString();
                var wa = p.WhatsApp || '';

                html += '<div class="bg-white rounded-[24px] overflow-hidden card-shadow border border-white h-full flex flex-col">';
                html += '<div class="h-32 bg-gray-100 w-full overflow-hidden">';
                html += '<img src="' + imgUrl + '" class="w-full h-full object-cover">';
                html += '</div>';
                html += '<div class="p-3 flex flex-col flex-grow">';
                html += '<p class="text-[8px] font-bold text-blue-500 uppercase">' + kat + '</p>';
                html += '<h4 class="text-sm font-bold text-gray-800 truncate mb-1">' + nama + '</h4>';
                html += '<p class="text-[10px] text-gray-400 mb-2 truncate"><i class="fa fa-store mr-1"></i>' + toko + '</p>';
                html += '<div class="flex justify-between items-center mt-auto">';
                html += '<span class="text-blue-600 font-extrabold text-sm">Rp' + harga + '</span>';
                html += '<button onclick="orderWA(\'' + wa + '\', \'' + nama + '\')" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md shadow-blue-200"><i class="fa fa-plus text-xs"></i></button>';
                html += '</div></div></div>';
            }
        } else {
            html += '<div class="col-span-2 text-center text-gray-400 py-10 text-sm">Belum ada produk terdaftar.</div>';
        }
        html += '</div>';
        container.innerHTML = html;
      }

      // --- HALAMAN TOKO (DAFTAR UMKM) ---
      else if(section === 'market') {
        html += '<div class="mb-6">';
        html += '<h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="fa fa-store text-blue-500"></i> UMKM Lingkungan</h3>';
        html += '<p class="text-xs text-gray-400">Dukung usaha tetangga kita</p>';
        html += '</div>';
        html += '<div class="space-y-4">';

        if (masterData.toko && masterData.toko.length > 0) {
            for (var k = 0; k < masterData.toko.length; k++) {
                var t = masterData.toko[k];
                var tNama = t['Nama Toko'] || 'Toko Warga';
                var tOwner = t['Pemilik'] || 'Warga Nipisi';
                var tDesc = t['Deskripsi'] || 'Usaha lokal lingkungan Nipisi';
                var tImg = t['GambarURL'] || 'https://cdn-icons-png.flaticon.com/512/1261/1261163.png';
                var tWa = t['WhatsApp'] || '';

                html += '<div class="bg-white p-4 rounded-[24px] card-shadow flex gap-4 items-center">';
                html += '<div class="w-16 h-16 rounded-2xl bg-blue-50 flex-shrink-0 overflow-hidden">';
                html += '<img src="' + tImg + '" class="w-full h-full object-cover">';
                html += '</div>';
                html += '<div class="flex-grow">';
                html += '<h4 class="font-bold text-gray-800 text-sm">' + tNama + '</h4>';
                html += '<p class="text-[10px] text-gray-500 uppercase font-bold tracking-wide mb-1">' + tOwner + '</p>';
                html += '<p class="text-[10px] text-gray-400 italic truncate w-48">' + tDesc + '</p>';
                html += '</div>';
                
                if(tWa) {
                    html += '<button onclick="window.open(\'https://wa.me/' + tWa + '\', \'_blank\')" class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center shadow-sm"><i class="fab fa-whatsapp text-lg"></i></button>';
                }
                html += '</div>';
            }
        } else {
            html += '<div class="text-center text-gray-400 py-10 text-sm">Belum ada toko terdaftar.</div>';
        }
        html += '</div>';
        container.innerHTML = html;
      }

      // --- HALAMAN PROFIL ---
      else if(section === 'profile') {
        var countToko = masterData.toko ? masterData.toko.length : 0;
        var countProd = masterData.produk ? masterData.produk.length : 0;
        
        html += '<div class="bg-white p-8 rounded-[32px] text-center card-shadow">';
        html += '<div class="w-24 h-24 mx-auto mb-4 p-1 bg-blue-100 rounded-full">';
        html += '<img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full rounded-full bg-white">';
        html += '</div>';
        html += '<h2 class="text-xl font-bold">Bpk. Kepala Lingkungan</h2>';
        html += '<p class="text-blue-600 text-sm font-medium mb-6">Lingkungan Nipisi</p>';
        html += '<div class="grid grid-cols-2 gap-4">';
        html += '<div class="bg-slate-50 p-4 rounded-2xl"><p class="text-[10px] text-gray-400 uppercase font-bold">UMKM Aktif</p><p class="text-lg font-bold text-slate-800">' + countToko + '</p></div>';
        html += '<div class="bg-slate-50 p-4 rounded-2xl"><p class="text-[10px] text-gray-400 uppercase font-bold">Produk</p><p class="text-lg font-bold text-slate-800">' + countProd + '</p></div>';
        html += '</div></div>';
        container.innerHTML = html;
      }
      
      // --- HALAMAN PETA ---
      else if(section === 'map') {
        html += '<div class="bg-white p-4 rounded-[32px] card-shadow">';
        html += '<h3 class="font-bold mb-4 px-2">Peta Wilayah</h3>';
        html += '<div class="w-full h-64 bg-slate-100 rounded-2xl flex items-center justify-center overflow-hidden">';
        // Menggunakan about:blank untuk mencegah error mixed content (http vs https)
        html += '<iframe src="about:blank" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>';
        html += '</div>';
        html += '<p class="text-center text-xs text-gray-400 mt-2">Silakan ganti URL iframe di kode dengan Embed Google Maps (HTTPS).</p>';
        html += '</div>';
        container.innerHTML = html;
      }
    }

    // --- FUNGSI FITUR TAMBAHAN ---

    function showLapor() {
      var html = '';
      html += '<div class="bg-white p-6 rounded-[32px] shadow-sm border border-orange-50">';
      html += '<h3 class="font-bold text-lg mb-4 text-orange-600">Form Pengaduan</h3>';
      html += '<input id="l-nama" placeholder="Nama Anda" class="w-full p-4 mb-3 rounded-2xl bg-slate-50 border-none text-sm">';
      html += '<input id="l-hal" placeholder="Hal yang dilaporkan" class="w-full p-4 mb-3 rounded-2xl bg-slate-50 border-none text-sm">';
      html += '<textarea id="l-isi" placeholder="Ceritakan detailnya..." class="w-full p-4 mb-4 rounded-2xl bg-slate-50 border-none text-sm" rows="4"></textarea>';
      html += '<button onclick="kirimLaporan()" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-orange-100">Kirim Laporan</button>';
      html += '</div>';
      document.getElementById('dynamic-content').innerHTML = html;
    }

    function kirimLaporan() {
      var nama = document.getElementById('l-nama').value;
      var judul = document.getElementById('l-hal').value;
      var isi = document.getElementById('l-isi').value;
      
      if(!nama || !isi) { alert("Mohon lengkapi form!"); return; }
      
      google.script.run.withSuccessHandler(function(res) { 
        alert(res); 
        loadSection('home'); 
      }).submitPengaduan({nama: nama, judul: judul, isi: isi});
    }

    function showIuran() {
      var html = '';
      html += '<div class="bg-white p-6 rounded-[32px] shadow-sm border border-indigo-50">';
      html += '<h3 class="font-bold text-lg mb-4 text-indigo-700">Cek Iuran Warga</h3>';
      html += '<div class="flex gap-2 mb-6">';
      html += '<input id="search-iuran" placeholder="Masukkan Nama..." class="flex-1 p-4 rounded-2xl bg-slate-50 border-none text-sm">';
      html += '<button onclick="prosesCekIuran()" class="bg-indigo-600 text-white px-6 rounded-2xl font-bold text-sm"><i class="fa fa-search"></i></button>';
      html += '</div>';
      html += '<div id="hasil-iuran" class="space-y-3"></div>';
      html += '</div>';
      document.getElementById('dynamic-content').innerHTML = html;
    }

    function prosesCekIuran() {
      var nama = document.getElementById('search-iuran').value;
      var resDiv = document.getElementById('hasil-iuran');
      resDiv.innerHTML = '<p class="text-center py-4 text-gray-400 text-xs">Mencari data...</p>';
      
      google.script.run.withSuccessHandler(function(data) {
        if(data.length === 0) { 
            resDiv.innerHTML = '<p class="text-center text-red-500 text-xs">Data tidak ditemukan.</p>'; 
            return; 
        }
        var html = '';
        for(var i=0; i<data.length; i++) {
            var d = data[i];
            var borderClass = (d.Status === 'Lunas') ? 'border-green-100 bg-green-50' : 'border-red-100 bg-red-50';
            var badgeClass = (d.Status === 'Lunas') ? 'bg-green-600 text-white' : 'bg-red-600 text-white';
            
            html += '<div class="p-4 rounded-2xl border ' + borderClass + '">';
            html += '<div class="flex justify-between items-center">';
            html += '<div><p class="text-[9px] font-bold text-slate-400 uppercase">' + d.Bulan + '</p><p class="font-bold text-slate-800">Rp' + Number(d.Jumlah).toLocaleString() + '</p></div>';
            html += '<span class="text-[10px] font-bold px-3 py-1 rounded-full ' + badgeClass + '">' + d.Status + '</span>';
            html += '</div></div>';
        }
        resDiv.innerHTML = html;
      }).cekIuranWarga(nama);
    }

    function showEmergency() {
      var html = '<h3 class="font-bold text-red-600 mb-4 px-2 italic">Telepon Penting</h3>';
      if (masterData.darurat) {
        for(var i=0; i<masterData.darurat.length; i++) {
          var d = masterData.darurat[i];
          html += '<a href="tel:' + d.Nomor + '" class="flex items-center justify-between bg-white p-5 rounded-[24px] mb-3 shadow-sm border-l-4 border-red-500">';
          html += '<span class="font-bold text-slate-700">' + d.Nama + '</span>';
          html += '<div class="bg-red-100 text-red-600 p-2 rounded-full"><i class="fa fa-phone-alt"></i></div>';
          html += '</a>';
        }
      }
      document.getElementById('dynamic-content').innerHTML = html;
    }

    // Pencarian Produk (Client Side)
    function searchProduct(v) {
      if(!masterData.produk) return;
      var list = document.getElementById('product-list');
      if(!list) return;
      
      var keyword = v.toLowerCase();
      var html = '';
      var found = 0;

      for (var i=0; i<masterData.produk.length; i++) {
          var p = masterData.produk[i];
          var pName = p['Nama Barang'] ? p['Nama Barang'].toLowerCase() : '';
          
          if (pName.includes(keyword)) {
              found++;
              var imgUrl = p.GambarURL || 'https://via.placeholder.com/300';
              
              html += '<div class="bg-white rounded-[24px] overflow-hidden card-shadow border border-white h-full flex flex-col">';
              html += '<div class="h-32 bg-gray-100 w-full overflow-hidden">';
              html += '<img src="' + imgUrl + '" class="w-full h-full object-cover">';
              html += '</div>';
              html += '<div class="p-3 flex flex-col flex-grow">';
              html += '<p class="text-[8px] font-bold text-blue-500 uppercase">' + p.Kategori + '</p>';
              html += '<h4 class="text-sm font-bold text-gray-800 truncate mb-1">' + p['Nama Barang'] + '</h4>';
              html += '<p class="text-[10px] text-gray-400 mb-2 truncate"><i class="fa fa-store mr-1"></i>' + (p['Toko'] || 'Nipisi') + '</p>';
              html += '<div class="flex justify-between items-center mt-auto">';
              html += '<span class="text-blue-600 font-extrabold text-sm">Rp' + Number(p.Harga).toLocaleString() + '</span>';
              html += '<button onclick="orderWA(\'' + p.WhatsApp + '\', \'' + p['Nama Barang'] + '\')" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md shadow-blue-200"><i class="fa fa-plus text-xs"></i></button>';
              html += '</div></div></div>';
          }
      }

      if (found === 0) {
          html = '<div class="col-span-2 text-center text-gray-400 text-xs py-4">Produk tidak ditemukan.</div>';
      }
      list.innerHTML = html;
    }

    function orderWA(num, item) { 
        if(!num) { alert("Nomor tidak tersedia."); return; }
        // Bersihkan nomor (hanya ambil angka)
        var phone = num.toString().replace(/[^0-9]/g, '');
        if(phone.startsWith('0')) phone = '62' + phone.substring(1);
        window.open('https://wa.me/' + phone + '?text=Halo, saya pesan ' + item + '.', '_blank'); 
    }

    // --- ADMIN DASHBOARD ---
    function showAdminLogin() {
      var p = prompt("Masukkan Password Admin:");
      if(p) {
          google.script.run.withSuccessHandler(function(v) { 
              if(v) renderAdmin(); 
              else alert("Password Salah!"); 
          }).checkAdminLogin(p);
      }
    }

    function renderAdmin() {
      var infoVal = "";
      if (masterData.pengumuman && masterData.pengumuman.length > 0) {
          infoVal = masterData.pengumuman[0].Isi || "";
      }

      var html = '';
      html += '<div class="bg-slate-900 text-white p-6 rounded-[32px]">';
      html += '<h2 class="font-bold text-lg mb-6 flex items-center gap-2"><i class="fa fa-user-shield text-blue-400"></i> Panel Admin</h2>';
      
      // Update Pengumuman
      html += '<div>';
      html += '<label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Update Pengumuman</label>';
      html += '<textarea id="adm-info" class="w-full p-4 rounded-2xl bg-slate-800 border-none text-white text-sm" rows="2">' + infoVal + '</textarea>';
      html += '<button onclick="saveInfo()" class="w-full bg-blue-600 text-white mt-2 py-3 rounded-2xl text-xs font-bold uppercase tracking-widest">Simpan Pengumuman</button>';
      html += '</div>';
      
      // Tambah Produk
      html += '<div class="pt-4 mt-6 border-t border-slate-800">';
      html += '<label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">Tambah Produk</label>';
      html += '<input id="p-nama" placeholder="Nama Barang" class="w-full p-4 mb-2 rounded-2xl bg-slate-800 border-none text-sm text-white">';
      html += '<input id="p-harga" placeholder="Harga" type="number" class="w-full p-4 mb-2 rounded-2xl bg-slate-800 border-none text-sm text-white">';
      html += '<input id="p-toko" placeholder="Nama Toko" class="w-full p-4 mb-2 rounded-2xl bg-slate-800 border-none text-sm text-white">';
      html += '<input id="p-wa" placeholder="WhatsApp" class="w-full p-4 mb-2 rounded-2xl bg-slate-800 border-none text-sm text-white">';
      html += '<input id="p-img" placeholder="Link Foto (URL)" class="w-full p-4 mb-4 rounded-2xl bg-slate-800 border-none text-sm text-white">';
      html += '<button onclick="saveProduct()" class="w-full bg-green-600 text-white py-4 rounded-2xl text-xs font-bold uppercase tracking-widest">Terbitkan Produk</button>';
      html += '</div>';
      html += '</div>';
      
      document.getElementById('dynamic-content').innerHTML = html;
    }

    function saveInfo() {
      var val = document.getElementById('adm-info').value;
      google.script.run.withSuccessHandler(function(res) { 
          alert(res); 
          location.reload(); 
      }).updateAnnouncement(val);
    }

    function saveProduct() {
      var o = { 
          nama: document.getElementById('p-nama').value, 
          harga: document.getElementById('p-harga').value, 
          toko: document.getElementById('p-toko').value, 
          wa: document.getElementById('p-wa').value, 
          gambar: document.getElementById('p-img').value, 
          kategori: 'Umum' 
      };
      if(!o.nama || !o.harga) { alert("Nama dan Harga wajib diisi"); return; }
      google.script.run.withSuccessHandler(function(res) { 
          alert(res); 
          location.reload(); 
      }).addProductFromAdmin(o);
    }
  </script>
</body>
</html>
